<project default="build-all"
         xmlns:j="jelly:core"
         xmlns:maven="jelly:maven">

    <goal name="build-all"
        description="Build and install each project">

        <maven:reactor
            basedir="${basedir}"
            includes="**/project.xml"
            excludes="reference/project.xml"
            goals="jar:install"
            banner="Building"
            ignoreFailures="false"
            />
    </goal>

    <postGoal name="xdoc:register-reports">
      <attainGoal name="maven-dotuml-plugin:register"/>  
      <attainGoal name="maven-changelog-plugin:deregister"/>  
      <attainGoal name="maven-checkstyle-plugin:deregister"/>
      <attainGoal name="maven-developer-activity-plugin:deregister"/>  
      <attainGoal name="maven-file-activity-plugin:deregister"/>  
    </postGoal>
    <preGoal name="xdoc:init">
      <attainGoal name="faq"/>  
    </preGoal>

    <preGoal name="nsis:generate-project">
	    
        <j:set var="base" value="${basedir}/target/dist"/>
        <j:set var="preOutDir" value="${base}/userbuild/"/>
	<j:set var="outDir" value="${preOutDir}/${maven.final.name}"/>
	<j:set var="maven.dist.bin.assembly.dir" value="${outDir}" />
    </preGoal>
	    
    <!-- put extra files in the binary distribution -->
    <postGoal name="dist:prepare-bin-filesystem">
            <!-- init -->
	    <j:set var="out" value="${maven.dist.bin.assembly.dir}/lib"/>
            <mkdir dir="${out}"/>
	    
	    <!-- Copy the runtime jar dependencies -->
	    <j:forEach var="lib" items="${pom.artifacts}">
	    <j:set var="jarDependency"
               value="${lib.dependency.getProperty('jar.manifest.classpath')}"/>
			<j:if test="${jarDependency == 'true'}">
		    	<j:set var="from"
			           value="${pom.getDependencyPath(lib.dependency.id)}"/>
			    <j:set var="to"
			           defaultValue="${lib.dependency.artifact}"
			           value="${lib.dependency.jar}"/>
     		    <copy todir="${out}" file="${from}"/>
			</j:if>
		</j:forEach>
	     <!-- pongo el jar ahi tambien -->
	     <move todir="${out}">
	        <fileset dir="${maven.dist.bin.assembly.dir}">
		   <include name="*.jar"/>
		</fileset>
	     </move>
            
	    <!-- bash file para correr -->
            <echo file="${maven.dist.bin.assembly.dir}/run.sh" >#!/bin/bash
# autogenerado, no editar
cd `dirname $$0`
LD_LIBRARY_PATH=`pwd`/lib:$$LD_LIBRARY_PATH

$$JAVA_HOME/bin/java -ea -jar lib/${maven.final.name}.jar 
       </echo>
       <echo file="${maven.dist.bin.assembly.dir}/run.bat" >
java -ea -jar lib/${maven.final.name}.jar 
       </echo>

       <chmod file="${maven.dist.bin.assembly.dir}/run.sh" perm="a+x"/>
        
	<!-- backup para el nsis -->

	<copy todir="${maven.nsis.build.dir}">
	  <fileset dir="${maven.dist.bin.assembly.dir}">
	    <include name="**/*"/>
	  </fileset>
        </copy>

    </postGoal>


</project>
